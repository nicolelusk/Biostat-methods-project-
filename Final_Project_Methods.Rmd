---
title: "Final_Project_Methods"
author: "Nicole Lusk and Kaitlin Heintzman"
date: "2025-11-18"
output: html_document
---

```{r}

library("here")
library("haven")
library("tidyverse")
Demographics<-read_xpt(here("DEMO_L.xpt"))
Fasting<-read_xpt(here("FASTQX_L.xpt"))
Insulin<-read_xpt(here("INS_L.xpt"))
Cholesterol<-read_xpt(here("TCHOL_L.xpt"))
Diabetes<-read_xpt(here("DIQ_L.xpt"))


FullData_df<-Demographics|>
  full_join(Fasting, by = "SEQN")|>
  full_join(Insulin, by = "SEQN")|>
  full_join(Cholesterol, by = "SEQN")|>
  full_join(Diabetes, by = "SEQN")

Data_df<-FullData_df|> 
  select("SEQN", "RIAGENDR", "RIDAGEYR", "PHQ020", "PHACOFHR", "PHQ030", "PHAALCHR", "PHAFSTHR", "LBXTC", "LBXIN", "DIQ010", "DIQ050", "DIQ160")|>
  rename("Sequence" = SEQN,
         "Sex" = RIAGENDR,
         "Age" = RIDAGEYR,
        "Coffee_or_Tea_Factor" = PHQ020, "Hrs_CoffeeTea" = PHACOFHR, 
        "Alcohol_Factor" = PHQ030, "Hrs_Alcohol" = PHAALCHR,
        "Hrs_Food" = PHAFSTHR, 
        "Cholesterol" = LBXTC,
        "Insulin" = LBXIN,
        "Diabetes" = DIQ010, "Taking_Insulin" = DIQ050, "Prediabetes" = DIQ160)|>
  mutate(Sex = case_when(Sex == 1 ~"male", 
                         Sex == 2 ~ "female"),
         Coffee_or_Tea_Factor = case_when(Coffee_or_Tea_Factor == 1 ~ "yes",
                                          Coffee_or_Tea_Factor == 2 ~"no",
                                          .default = NA),
         Alcohol_Factor = case_when(Alcohol_Factor == 1 ~ "yes",
                                 Alcohol_Factor == 2 ~ "no", 
                                 .default = NA),
         Diabetes = ifelse(Diabetes == 1, "yes", "other"),
         Prediabetes = ifelse(Prediabetes == 1, "yes", "other"),
         Taking_Insulin = ifelse(Taking_Insulin == 1, "yes", "other"))
```

```{r}
women_only<-Data_df|>
  filter(Sex == "female")
```

# Making the Models 

```{r}
Cholesterol_lm<-lm(Cholesterol ~ Hrs_Food, data = Data_df)
Insulin_lm<-lm(Insulin ~ Hrs_Food, data = Data_df)
```

# Assumption

## Linearity 

### Cholesterol
```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Cholesterol))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Cholesterol")
```

### Insulin

```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Insulin))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Insulin")
```

### By Sex 

#### Cholesterol
```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Cholesterol))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Cholesterol")+
  facet_wrap(~Sex)
```

#### Insulin

```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Insulin))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Insulin")+
  facet_wrap(~Sex)
```

### By Diabetes 

#### Cholesterol
```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Cholesterol))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Cholesterol")+
  facet_wrap(~Diabetes)
```

#### Insulin

```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Insulin))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Insulin")+
  facet_wrap(~Diabetes)

```

### By Age Groups

```{r}
Data_df<-Data_df|> filter(Age >= 18)|>
  mutate(Age_Group = if_else(Age > 65, "retired", "working")
  )
```

#### Cholesterol
```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Cholesterol))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Cholesterol")+
  facet_wrap(~Age_Group)
```

#### Insulin

```{r}
ggplot(data = Data_df, aes(x = Hrs_Food, y = Insulin))+
  geom_point()+
  theme_minimal()+
  labs(title = "Fasting vs. Insulin")+
  facet_wrap(~Age_Group)

```

For all of our groups, we can see that there is no curvature or concerning patterns across our independent variable of Hours Fasted from food, and therefore the assumptions for linearity are met. 

## Independence
Since the data came from NHANES, we can assume that each person is independent from all other people, therefore these assumptions are met. 

## Normal Residuals 

### Cholesterol
```{r}
qqnorm(Cholesterol_lm$residuals)
qqline(Cholesterol_lm$residuals)
```

### Insulin
```{r}
qqnorm(Insulin_lm$residuals)
qqline(Insulin_lm$residuals)


# Possibly could transform insulin to meet assumptions
qqnorm(log(Insulin_lm$residuals))
qqline(log(Insulin_lm$residuals))
```

## Equal Variance of Y for all values of X


### Cholesterol

```{r}
data.frame(residuals = Cholesterol_lm$residuals,
           yhat = Cholesterol_lm$fitted.values)|>
  ggplot(aes(x = yhat, y= residuals))+
  geom_point()+
  theme_minimal()+
  geom_hline(yintercept = 0)+
  labs(x = "Fitted", y = "Residuals")

```

### Insulin
```{r}
data.frame(residuals = Insulin_lm$residuals,
           yhat = Insulin_lm$fitted.values)|>
  ggplot(aes(x = yhat, y= residuals))+
  geom_point()+
  theme_minimal()+
  geom_hline(yintercept = 0)+
  labs(x = "Fitted", y = "Residuals")
```

